<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>canvas</title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<link rel="stylesheet" href="/css/style.css">
</head>
<body style="text-align: center;">
	<header></header>
	<canvas id="canvas" width="200" height="400" style="background-color: #eee"></canvas>
	<form action="">
		<div>
			<ul class="uk-list">
				<li>
					<div uk-form-custom>
						<input type="file" id="file">
						<i uk-icon="upload">upload</i>
					</div>
				</li>
				<li>
					<label>
						<input oninput="setVal('r',this.value)" onchange="setVal('r'this.value)" min=-180 max=180 type="range" id="range" class="uk-range">		
					</label>
				</li>
				<li>
					
				</li>
				<li>
				
				</li>
			</ul>		
		</div>
	</form>
<!-- 	<table>
		<tr>
			<td>origX:</td>
			<td>
				<input oninput="setVal('x',this.value)" onchange="setVal('x'this.value)" min=-200 max=400 type="range">
			</td>
		</tr>
		<tr>
			<td>origY:</td>
			<td>
				<input oninput="setVal('y',this.value)" onchange="setVal('y'this.value)" min=-200 max=600 type="range">
			</td>
		</tr>
		<tr>
			<td>Rotation:</td>
			<td>
				<input oninput="setVal('r',this.value)" onchange="setVal('r'this.value)" min=-180 max=180 type="range">
			</td>
		</tr>
		<tr>
			<td>scaleX:</td>
			<td>
				<input oninput="setVal('sx',this.value)" onchange="setVal('sx'this.value)" min=0.5 max=1.5 step=0.1 type="range">
			</td>
		</tr>
		<tr>
			<td>scaleY:</td>
			<td>
				<input oninput="setVal('sy',this.value)" onchange="setVal('sy'this.value)" min=0.5 max=1.5 step=0.1 type="range">
			</td>
		</tr>
		<tr>
			<td>SkewX:</td>
			<td>
				<input oninput="setVal('skx',this.value)" onchange="setVal('skx'this.value)" min=-45 max=45 type="range">
			</td>
		</tr>
		<tr>
			<td>SkewY:</td>
			<td>
				<input oninput="setVal('sky',this.value)" onchange="setVal('sky'this.value)" min=-45 max=45 type="range">
			</td>
		</tr>
	</table> -->
	<script src="/js/bundle.js"></script>
	<script>
		var counter=0;
		var origx=100; //x座標
		var origy=200; //y座標

		var rotation=0; //角度
		var skewx=0; //傾斜変形:x
		var skewy=0; //傾斜変形:y
		var scalex=1; //比率:x
		var scaley=1; //比率:y
		var uploadImgSrc;
		const file = document.getElementById('file');
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');

		function loadLocalImage(e) {
			// ファイル情報を取得
			var fileData = e.target.files[0];

			// 画像ファイル以外は処理を止める
			if(!fileData.type.match('image.*')) {
				alert('画像を選択してください');
				return;
			}	

			// FileReaderオブジェクトを使ってファイル読み込み
			var reader = new FileReader();
			// ファイル読み込みに成功したときの処理
			reader.onload = function() {
				// Canvas上に表示する
				uploadImgSrc = reader.result;
				// canvasDraw();
				showCanvas();
			}
			// ファイル読み込みを実行
			reader.readAsDataURL(fileData);
		}

		// ファイルが指定された時にloadLocalImage()を実行
		file.addEventListener('change', loadLocalImage, false);

		function setVal(which , val) {
			console.log( which+ ',' + val)
			switch(which) {
				case 'x':origx=parseFloat(val);
				break;
				case 'y':origy=parseFloat(val);
				break;
				case 'sx':scalex=parseFloat(val);
				break;
				case 'sy':scaley=parseFloat(val);
				break;  
				case 'r':rotation=parseFloat(val);
				break;     
				case 'skx':skewx=parseFloat(val);
				break;
				case 'sky':skewy=parseFloat(val);
				break;  
			}
			showCanvas();
		}

		function showCanvas() {
			ctx.setTransform(1 , 0 , 0 , 1 , 0 , 0);
			ctx.fillStyle='#eee';
			ctx.fillRect(0 , 0 , 200 , 400 );
			counter++;
			var img = new Image();
			img.src = uploadImgSrc;
			var anglex = rotation + skewy;
			var angley = rotation + skewx;
			var rx = Math.PI * anglex / 180;
			var ry = Math.PI * angley / 180;
			ctx.setTransform(
				scalex * Math.cos(rx),
				scalex * Math.sin(rx),
				-scaley * Math.sin(ry),
				scaley * Math.cos(ry),
				origx,
				origy);
			img.onload = function() {
				ctx.drawImage(img, 0 , 0 , img.width , img.height , -img.width / 2 , -img.height / 2 , img.width , img.height);
			}
		}
	</script>
</body>
</html>